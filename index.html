<!DOCTYPE html>
<html>
<head>
    <title>The Peaceful Navigator</title>
    <style>
        /* Basic styling for the map container */
        #map {
            height: 90vh; /* Adjust height slightly to make space for button/header */
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* Optional: Style the button */
        #controls {
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h3>The Peaceful Navigator</h3>
    <div id="controls">
        <button id="centerButton">Center on My Location</button>
    </div>
    <div id="map"></div>

    <script src="camera_data.js"></script>

    <script>
       // --- Keep your existing 'icons' definition here ---
       const icons = { /* ... */ };

       function initMap() {
            console.log("initMap called.");
            const sfCenter = { lat: 37.7749, lng: -122.4194 };
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: sfCenter,
                mapTypeId: 'roadmap'
            });
            console.log("Map object created:", map);
            const infowindow = new google.maps.InfoWindow();

            // --- Define Icons with Scaled Size ---
            // Adjust the Size(width, height) values as desired
            const iconWidth = 30;
            const iconHeight = 30;

            const icons = {
                 speed: {
                     url: "https://googleusercontent.com/maps.google.com/1", // HTTPS blue dot
                     scaledSize: new google.maps.Size(iconWidth, iconHeight)
                 },
                 "red light": {
                     url: "https://googleusercontent.com/maps.google.com/2", // HTTPS red dot
                     scaledSize: new google.maps.Size(iconWidth, iconHeight)
                 }
             };
             console.log("Icons object defined:", icons);
            // --- End Icon Definition ---


            if (typeof cameraData !== 'undefined' && cameraData.length > 0) {
                console.log(`cameraData found with ${cameraData.length} items. Starting loop...`);

                cameraData.forEach((camera, index) => {
                    // console.log(`Processing camera ${index + 1}/${cameraData.length}:`, camera); // Keep logs if needed
                    try {
                        // --- Basic data validation (keep from previous version) ---
                        if (camera.latitude == null || camera.longitude == null || camera.type == null || camera.name == null) {
                             console.warn(`Camera ${index + 1} has missing data. Skipping.`); return; }
                        const position = { lat: parseFloat(camera.latitude), lng: parseFloat(camera.longitude) };
                        if (isNaN(position.lat) || isNaN(position.lng)) {
                              console.error(`Invalid coordinates (NaN) for camera ${index + 1}. Skipping.`); return; }
                        if (position.lat < -90 || position.lat > 90 || position.lng < -180 || position.lng > 180) {
                              console.error(`Coordinates out of range for camera ${index + 1}. Skipping.`); return; }
                        // console.log(`  Prepared position for marker ${index + 1}:`, position);

                        // --- Icon Logic (Assigns the whole icon object or null) ---
                        const currentType = camera.type;
                        // console.log(`  Icon lookup key: '${currentType}'`);

                        let markerIconObject = null; // Default to null (Google's default marker)

                        if (currentType === 'speed' && icons['speed']) {
                             markerIconObject = icons['speed']; // Assign the whole object {url: ..., scaledSize: ...}
                             // console.log("  Using 'speed' icon object.");
                        } else if (currentType === 'red light' && icons['red light']) {
                             markerIconObject = icons['red light']; // Assign the whole object
                             // console.log("  Using 'red light' icon object.");
                        } else {
                             // console.warn(`  No specific icon found for type '${currentType}', using default Google marker.`);
                        }
                        // --- End Icon Logic ---

                        // Create the marker, assigning the icon object
                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: `${camera.name} (${currentType})`,
                            icon: markerIconObject // Assign the object (or null)
                        });
                        // console.log(`  Marker ${index + 1} created (using icon object: ${markerIconObject ? JSON.stringify(markerIconObject) : 'default'}):`, marker);

                        marker.addListener('click', () => {
                            const content = `<strong>${camera.name}</strong><br>Type: ${currentType}<br>Coords: ${camera.latitude.toFixed(6)}, ${camera.longitude.toFixed(6)}`;
                            infowindow.setContent(content);
                            infowindow.open(map, marker);
                        });

                    } catch (error) {
                        console.error(`Error processing camera ${index + 1}:`, camera, error);
                    }
                }); // End of forEach loop
                 console.log("Finished processing all cameras.");

            } else {
                console.error("Camera data is not loaded, is empty, or is not an array.");
                // ... (center marker code) ...
            }

            // --- Keep the Geolocation Button Functionality ---
            const locationButton = document.getElementById("centerButton");
            locationButton.addEventListener("click", () => {
                // ... (geolocation listener code remains the same) ...
            });
            // --- END OF Geolocation Code ---

       } // End of initMap function

       // --- Update handleLocationError to accept the error object ---
       function handleLocationError(browserHasGeolocation, infoWindow, pos, error) { // Added 'error' parameter
            let message;
            // Use the passed 'error' object directly
            if (!browserHasGeolocation) {
                 message = "Error: Your browser doesn't support geolocation.";
            } else if (error) { // Check if error object exists
                 switch (error.code) {
                     case error.PERMISSION_DENIED: // Constants are usually uppercase
                     case 1: // Add numeric codes as fallback
                         message = "Error: You denied the request for Geolocation.";
                         break;
                     case error.POSITION_UNAVAILABLE:
                     case 2:
                         message = "Error: Location information is unavailable.";
                         break;
                     case error.TIMEOUT:
                     case 3:
                         message = "Error: The request to get user location timed out.";
                         break;
                     default:
                         message = `Error: An unknown geolocation error occurred (Code: ${error.code}).`;
                         break;
                 }
            } else {
                 // Fallback if error object isn't passed correctly
                 message = browserHasGeolocation ? "Error: The Geolocation service failed (no error code)." : "Error: Your browser doesn't support geolocation.";
            }
            console.error("handleLocationError:", message); // Log the error message
            alert(message);
       }
       // --- END OF handleLocationError modification ---


       // --- Keep your existing gm_authFailure function here ---
       function gm_authFailure() { /* ... */ }


       // --- Keep your existing gm_authFailure function here ---
       function gm_authFailure() { /* ... */ }

    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbUiwIu1CxvE9lEbqLevKFRSgUGilI-e0&callback=initMap&loading=async&onerror=gm_authFailure">
    </script>

</body>
</html>
