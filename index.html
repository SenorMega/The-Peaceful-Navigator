<!DOCTYPE html>
<html>
<head>
    <title>SF Camera Map</title>
    <style>
        /* Basic styling for the map container */
        #map {
            height: 90vh; /* Adjust height slightly to make space for button/header */
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* Optional: Style the button */
        #controls {
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h3>San Francisco Speed and Red Light Cameras</h3>
    <div id="controls">
        <button id="centerButton">Center on My Location</button>
    </div>
    <div id="map"></div>

    <script src="camera_data.js"></script>

    <script>
       // --- Keep your existing 'icons' definition here ---
       const icons = { /* ... */ };

       function initMap() {
            console.log("initMap called.");
            const sfCenter = { lat: 37.7749, lng: -122.4194 };
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: sfCenter,
                mapTypeId: 'roadmap'
            });
            console.log("Map object created:", map);
            const infowindow = new google.maps.InfoWindow();

            // --- Define Icons (using simple standard URLs) ---
             const icons = {
                 speed: { // Key 'speed'
                     url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png", // Standard blue dot
                 },
                 "red light": { // Key 'red light' (in quotes)
                     url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png", // Standard red dot
                 }
             };
             console.log("Icons object defined:", icons);
            // --- End Icon Definition ---


            if (typeof cameraData !== 'undefined' && cameraData.length > 0) {
                console.log(`cameraData found with ${cameraData.length} items. Starting loop...`);

                cameraData.forEach((camera, index) => {
                    console.log(`Processing camera ${index + 1}/${cameraData.length}:`, camera);
                    try {
                        if (camera.latitude == null || camera.longitude == null || camera.type == null || camera.name == null) {
                            console.warn(`Camera ${index + 1} has missing data. Skipping.`); return;
                        }
                        const position = { lat: parseFloat(camera.latitude), lng: parseFloat(camera.longitude) };
                        if (isNaN(position.lat) || isNaN(position.lng)) {
                             console.error(`Invalid coordinates (NaN) for camera ${index + 1}. Skipping.`); return;
                        }
                         if (position.lat < -90 || position.lat > 90 || position.lng < -180 || position.lng > 180) {
                             console.error(`Coordinates out of range for camera ${index + 1}. Skipping.`); return;
                         }
                        console.log(`  Prepared position for marker ${index + 1}:`, position);

                        // --- Refined Icon Logic ---
                        const currentType = camera.type; // Get the type string
                        console.log(`  Icon lookup key: '${currentType}'`); // Log the exact type string being used

                        let markerIconUrl = null; // Default to null (will use Google's default teardrop)

                        if (currentType === 'speed' && icons['speed']) {
                             markerIconUrl = icons['speed'].url;
                             console.log("  Using 'speed' icon.");
                        } else if (currentType === 'red light' && icons['red light']) {
                             markerIconUrl = icons['red light'].url;
                             console.log("  Using 'red light' icon.");
                        } else {
                             console.warn(`  No specific icon found for type '${currentType}', using default Google marker.`);
                        }
                        // --- End Refined Icon Logic ---

                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: `${camera.name} (${currentType})`, // Use currentType here too
                            icon: markerIconUrl // Assign the URL directly (or null for default)
                        });
                        console.log(`  Marker ${index + 1} created (using icon URL: ${markerIconUrl || 'default'}):`, marker);

                        marker.addListener('click', () => {
                            const content = `<strong>${camera.name}</strong><br>Type: ${currentType}<br>Coords: ${camera.latitude.toFixed(6)}, ${camera.longitude.toFixed(6)}`;
                            infowindow.setContent(content);
                            infowindow.open(map, marker);
                        });

                    } catch (error) {
                        console.error(`Error processing camera ${index + 1}:`, camera, error);
                    }
                }); // End of forEach loop
                 console.log("Finished processing all cameras.");

            } else {
                console.error("Camera data is not loaded, is empty, or is not an array.");
                // ... (center marker code) ...
            }

            // --- NEW: Add Geolocation Button Functionality (with extra logging) ---
            const locationButton = document.getElementById("centerButton");

            locationButton.addEventListener("click", () => {
                 console.log("Center on Me button clicked."); // <<< DID THIS APPEAR?
                 locationButton.disabled = true;
                 locationButton.textContent = "Locating...";

                 if (navigator.geolocation) {
                     console.log("Browser supports geolocation. Attempting getCurrentPosition..."); // <<< DID THIS APPEAR?
                     navigator.geolocation.getCurrentPosition(
                         (position) => { // Success Callback
                             console.log("Geolocation success. Position:", position); // <<< DID THIS APPEAR?
                             try {
                                 const userLocation = {
                                     lat: position.coords.latitude,
                                     lng: position.coords.longitude,
                                 };
                                 console.log("Setting center to:", userLocation); // <<< DID THIS APPEAR?
                                 map.setCenter(userLocation);
                                 map.setZoom(15); // Zoom in closer to user's location

                                 // Optional: Add a marker for the user's location
                                 console.log("Adding user location marker."); // <<< DID THIS APPEAR?
                                 new google.maps.Marker({
                                     position: userLocation,
                                     map: map,
                                     title: "Your Location"
                                     // icon: 'some-user-icon.png' // Optional distinct icon
                                 });

                                 console.log("Map centered and zoomed successfully."); // <<< DID THIS APPEAR?
                             } catch (e) {
                                 console.error("Error inside geolocation success callback:", e); // Catch unexpected errors during centering/marker
                             } finally {
                                 locationButton.textContent = "Center on My Location";
                                 locationButton.disabled = false;
                             }
                         },
                         (geoError) => { // Error Callback
                             // Log the specific error object from the API
                             console.error("Geolocation error callback triggered. Error object:", geoError); // <<< DID THIS APPEAR?
                             handleLocationError(true, infowindow, map.getCenter(), geoError); // Pass error object
                             locationButton.textContent = "Center on My Location";
                             locationButton.disabled = false;
                         }
                         // Optional: Add options object for geolocation (e.g., timeout, accuracy)
                         // { maximumAge: 0, timeout: 10000, enableHighAccuracy: true }
                     );
                 } else {
                     // Browser doesn't support Geolocation
                     console.warn("Geolocation not supported by this browser."); // <<< DID THIS APPEAR?
                     handleLocationError(false, infowindow, map.getCenter(), null); // Pass null for error
                     locationButton.textContent = "Geolocation Unavailable";
                     // Maybe re-enable button but have it do nothing or show message?
                     // locationButton.disabled = false; // Re-enable if preferred
                 }
            });
            // --- END OF Geolocation Code ---
             locationButton.addEventListener("click", () => { /* ... */ });

       } // End of initMap function

       // --- Update handleLocationError to accept the error object ---
       function handleLocationError(browserHasGeolocation, infoWindow, pos, error) { // Added 'error' parameter
            let message;
            // Use the passed 'error' object directly
            if (!browserHasGeolocation) {
                 message = "Error: Your browser doesn't support geolocation.";
            } else if (error) { // Check if error object exists
                 switch (error.code) {
                     case error.PERMISSION_DENIED: // Constants are usually uppercase
                     case 1: // Add numeric codes as fallback
                         message = "Error: You denied the request for Geolocation.";
                         break;
                     case error.POSITION_UNAVAILABLE:
                     case 2:
                         message = "Error: Location information is unavailable.";
                         break;
                     case error.TIMEOUT:
                     case 3:
                         message = "Error: The request to get user location timed out.";
                         break;
                     default:
                         message = `Error: An unknown geolocation error occurred (Code: ${error.code}).`;
                         break;
                 }
            } else {
                 // Fallback if error object isn't passed correctly
                 message = browserHasGeolocation ? "Error: The Geolocation service failed (no error code)." : "Error: Your browser doesn't support geolocation.";
            }
            console.error("handleLocationError:", message); // Log the error message
            alert(message);
       }
       // --- END OF handleLocationError modification ---


       // --- Keep your existing gm_authFailure function here ---
       function gm_authFailure() { /* ... */ }


       // --- Keep your existing gm_authFailure function here ---
       function gm_authFailure() { /* ... */ }

    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbUiwIu1CxvE9lEbqLevKFRSgUGilI-e0&callback=initMap&loading=async&onerror=gm_authFailure">
    </script>

</body>
</html>
