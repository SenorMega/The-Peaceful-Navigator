<!DOCTYPE html>
<html>
<head>
    <title>The Peaceful Navigator</title>
    <style>
        /* Basic styling for the map container */
        #map {
            height: 90vh; /* Adjust height slightly to make space for button/header */
            width: 100%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* Optional: Style the button */
        #controls {
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h3>The Peaceful Navigator</h3>
    <div id="controls">
        <button id="centerButton">Center on My Location</button>
    </div>
    <div id="map"></div>

    <script src="camera_data.js"></script>

 <script>
     // Global functions need to be defined before Google Maps callback tries to run initMap

     // --- Helper function to handle geolocation errors ---
     function handleLocationError(browserHasGeolocation, infoWindow, pos, error) {
         let message;
         if (!browserHasGeolocation) {
             message = "Error: Your browser doesn't support geolocation.";
         } else if (error) {
             switch (error.code) {
                 case error.PERMISSION_DENIED: case 1:
                     message = "Error: You denied the request for Geolocation."; break;
                 case error.POSITION_UNAVAILABLE: case 2:
                     message = "Error: Location information is unavailable."; break;
                 case error.TIMEOUT: case 3:
                     message = "Error: The request to get user location timed out."; break;
                 default:
                     message = `Error: An unknown geolocation error occurred (Code: ${error.code}).`; break;
             }
         } else {
             message = browserHasGeolocation ? "Error: The Geolocation service failed (no error code)." : "Error: Your browser doesn't support geolocation.";
         }
         console.error("handleLocationError:", message);
         alert(message);
     }

     // --- Google Maps API load error handler ---
     function gm_authFailure() {
         console.error("Google Maps API failed to load. Check API key, billing, restrictions, and network.");
         alert('FATAL ERROR: Google Maps could not be loaded. Please check the console for details.');
         document.getElementById('map').innerHTML = '<p style="padding: 20px; text-align: center; color: red;">Error: Could not load Google Maps. API key, billing, or network issue likely.</p>';
     }

// --- Main Map Initialization Function (called by Google Maps API) ---
     function initMap() {
         console.log("initMap called.");
         try {
             const sfCenter = { lat: 37.7749, lng: -122.4194 };

             if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                  console.error("FATAL: google.maps object not available in initMap. API load failed earlier.");
                  gm_authFailure(); return;
             }

             const map = new google.maps.Map(document.getElementById("map"), {
                 zoom: 12,
                 center: sfCenter,
                 mapTypeId: 'roadmap'
             });
             console.log("Map object created:", map);
             const infowindow = new google.maps.InfoWindow();

             /* --- Icons Definition Block (Keep commented out for now) ---
             const iconWidth = 30;
             const iconHeight = 30;
             const icons = { ... };
             */

             if (typeof cameraData !== 'undefined' && cameraData.length > 0) {
                 console.log(`cameraData found with ${cameraData.length} items. Starting loop...`);

                 cameraData.forEach((camera, index) => {
                     try {
                         // --- Data validation ---
                         if (camera.latitude == null || camera.longitude == null || camera.type == null || camera.name == null) { console.warn(`Camera ${index + 1} missing data. Skipping.`); return; }
                         const position = { lat: parseFloat(camera.latitude), lng: parseFloat(camera.longitude) };
                         if (isNaN(position.lat) || isNaN(position.lng)) { console.error(`Invalid coords (NaN) camera ${index + 1}. Skipping.`); return; }
                         if (position.lat < -90 || position.lat > 90 || position.lng < -180 || position.lng > 180) { console.error(`Coords out of range camera ${index + 1}. Skipping.`); return; }

                         const currentType = camera.type;

                         // *** USING DEFAULT MARKERS (icon: null) ***
                         const marker = new google.maps.Marker({
                             position: position,
                             map: map,
                             title: `<span class="math-inline">\{camera\.name\} \(</span>{currentType})`,
                             icon: null // Force default marker
                         });
                         // console.log(`  Marker ${index + 1} created (default icon)`);

                         // --- Listener ---
                         marker.addListener('click', () => {
                             const content = `<strong>${camera.name}</strong><br>Type: ${currentType}<br>Coords: ${camera.latitude.toFixed(6)}, ${camera.longitude.toFixed(6)}`;
                             infowindow.setContent(content);
                             infowindow.open(map, marker);
                         });

                     } catch (error) {
                         console.error(`Error processing camera ${index + 1}:`, camera, error);
                     }
                 }); // End of forEach loop
                  console.log("Finished processing all cameras.");

             } else {
                 console.error("Camera data is not loaded, is empty, or is not an array.");
                 const centerMarker = new google.maps.Marker({ position: sfCenter, map: map, title: "No camera data loaded" });
             }

             // --- Geolocation Button Functionality (Ensuring it's active) ---
             const locationButton = document.getElementById("centerButton");
             // Add log to ensure button is found
             console.log("Button element found:", locationButton);

             if (locationButton) { // Check if button exists before adding listener
                 locationButton.addEventListener("click", () => {
                      console.log("Center on Me button clicked."); // Log click
                      locationButton.disabled = true;
                      locationButton.textContent = "Locating...";

                      if (navigator.geolocation) {
                          console.log("Browser supports geolocation. Attempting getCurrentPosition...");
                          navigator.geolocation.getCurrentPosition(
                              (position) => { // Success
                                  console.log("Geolocation success. Position:", position);
                                  try {
                                      const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                                      console.log("Setting center to:", userLocation);
                                      map.setCenter(userLocation);
                                      map.setZoom(15);
                                      console.log("Adding user location marker.");
                                      new google.maps.Marker({ position: userLocation, map: map, title: "Your Location" });
                                      console.log("Map centered/zoomed.");
                                  } catch (e) { console.error("Error in success callback:", e); }
                                  finally {
                                      locationButton.textContent = "Center on My Location";
                                      locationButton.disabled = false;
                                  }
                              },
                              (geoError) => { // Error
                                  console.error("Geolocation error callback triggered:", geoError);
                                  handleLocationError(true, infowindow, map.getCenter(), geoError);
                                  locationButton.textContent = "Center on My Location";
                                  locationButton.disabled = false;
                              }
                          );
                      } else {
                          console.warn("Geolocation not supported.");
                          handleLocationError(false, infowindow, map.getCenter(), null);
                          locationButton.textContent = "Geolocation Unavailable";
                      }
                 });
                 console.log("Click listener attached to button."); // Confirm listener attachment
             } else {
                 console.error("Could not find button element with ID 'centerButton'.");
             }
             // --- END OF Geolocation Code ---

         } catch (initError) {
              console.error("Error during initMap execution:", initError);
              gm_authFailure();
         }
      } // End of initMap function

     // --- Keep handleLocationError function ---
     function handleLocationError(browserHasGeolocation, infoWindow, pos, error) { /* ... */ }

     // --- Keep gm_authFailure function ---
     function gm_authFailure() { /* ... */ }

 </script>

</body>
</html>
